<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Tickets de Soporte - Copiermaster C&G</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        /* Style for table headers */
        th {
            position: sticky;
            top: 0;
            background-color: #f8fafc; /* bg-slate-50 */
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Login Screen -->
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg border border-gray-200">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/6qRNQd57/468963711-3994290450845859-6671631898219414239-n-removebg-preview.webp" alt="Logo" class="mx-auto h-32">
                <h1 class="text-2xl font-bold text-gray-800 mt-4">Acceso al Panel de Administración</h1>
                <p class="text-gray-500">Por favor, inicie sesión para continuar.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-lime-500 focus:border-lime-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-lime-500 focus:border-lime-500">
                </div>
                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700">
                        Iniciar Sesión
                    </button>
                </div>
            </form>
            <p id="login-error" class="mt-4 text-center text-sm text-red-600"></p>
        </div>
    </div>

    <!-- Admin Panel (Hidden by default) -->
    <div id="admin-panel-container" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">Panel de Administración de Tickets</h1>
                <div class="flex items-center gap-4">
                     <button id="export-csv-button" class="flex items-center gap-2 bg-lime-500 text-white font-semibold px-4 py-2 rounded-md shadow-md hover:bg-lime-600 transition duration-300">
                        <i data-lucide="sheet" class="h-5 w-5"></i>
                        Generar Reporte (CSV)
                    </button>
                    <button id="logout-button" class="flex items-center gap-2 bg-red-500 text-white font-semibold px-4 py-2 rounded-md shadow-md hover:bg-red-600 transition duration-300">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            <div id="loader" class="text-center py-12">
                <div class="w-8 h-8 border-4 border-lime-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                <p class="mt-4 text-gray-600">Cargando tickets...</p>
            </div>

            <div id="tickets-container" class="hidden bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Ticket</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asignado a</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Tickets will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                 <p id="no-tickets-message" class="hidden text-center py-12 text-gray-500">No hay tickets para mostrar.</p>
            </div>
        </main>

        <!-- Modal for Ticket Details -->
        <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Detalles del Ticket</h2>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-800">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div id="modal-body" class="p-6 space-y-4 overflow-y-auto">
                    <!-- Modal content will be inserted here -->
                </div>
                <div class="p-6 bg-slate-50 border-t mt-auto">
                     <button id="save-changes-button" class="w-full flex justify-center items-center gap-2 bg-gray-800 text-white font-semibold px-6 py-3 rounded-md shadow-lg hover:bg-gray-900 transition duration-300">
                        Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID", storageBucket: "YOUR_STORAGE_BUCKET", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentEditingTicketId = null;

        const loginContainer = document.getElementById('login-container');
        const adminPanelContainer = document.getElementById('admin-panel-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');

        // Auth state listener
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                loginContainer.classList.add('hidden');
                adminPanelContainer.classList.remove('hidden');
                lucide.createIcons();
                listenForTickets();
            } else {
                // User is signed out
                loginContainer.classList.remove('hidden');
                adminPanelContainer.classList.add('hidden');
            }
        });

        // Login form submission
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Login failed:", error);
                    loginError.textContent = "Correo o contraseña incorrectos.";
                });
        });

        // Logout button
        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });


        function listenForTickets() {
            const ticketsCollectionPath = `/artifacts/${appId}/public/data/tickets`;
            const ticketsQuery = query(collection(db, ticketsCollectionPath), orderBy("fechaCreacion", "desc"));

            onSnapshot(ticketsQuery, (snapshot) => {
                const ticketsTableBody = document.getElementById('tickets-table-body');
                const loader = document.getElementById('loader');
                const ticketsContainer = document.getElementById('tickets-container');
                const noTicketsMessage = document.getElementById('no-tickets-message');
                
                ticketsTableBody.innerHTML = '';
                loader.classList.add('hidden');
                ticketsContainer.classList.remove('hidden');

                if (snapshot.empty) {
                    noTicketsMessage.classList.remove('hidden');
                } else {
                    noTicketsMessage.classList.add('hidden');
                }

                snapshot.forEach(doc => {
                    const ticket = doc.data();
                    ticket.id = doc.id;
                    const row = createTicketRow(ticket);
                    ticketsTableBody.appendChild(row);
                });
                lucide.createIcons();
            }, (error) => {
                console.error("Error listening for tickets:", error);
                document.getElementById('loader').innerHTML = '<p class="text-red-600">No se pudieron cargar los tickets. Intenta recargar la página.</p>';
            });
        }

        function createTicketRow(ticket) {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            
            const statusColor = getStatusColor(ticket.estado);
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${ticket.id.substring(0, 6)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ticket.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${ticket.asignadoA || '---'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ticket.fechaCreacion ? new Date(ticket.fechaCreacion.seconds * 1000).toLocaleString() : 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${ticket.estado}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button data-ticket-id="${ticket.id}" class="view-details-button text-lime-600 hover:text-lime-900">Ver / Editar</button>
                </td>
            `;
            return tr;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Abierto': return 'bg-blue-100 text-blue-800';
                case 'En Proceso': return 'bg-yellow-100 text-yellow-800';
                case 'Cerrado': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        async function updateTicket(ticketId, data) {
            const ticketDocRef = doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId);
            try {
                await updateDoc(ticketDocRef, data);
                console.log(`Ticket ${ticketId} updated successfully.`);
            } catch (error) {
                console.error("Error updating ticket: ", error);
            }
        }

        // Modal Logic
        const modal = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const closeModalButton = document.getElementById('close-modal-button');
        const saveChangesButton = document.getElementById('save-changes-button');

        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('view-details-button')) {
                currentEditingTicketId = e.target.dataset.ticketId;
                const ticketDocRef = doc(db, `/artifacts/${appId}/public/data/tickets`, currentEditingTicketId);
                const ticketSnap = await getDoc(ticketDocRef);
                if (ticketSnap.exists()) {
                    const ticketData = ticketSnap.data();
                    ticketData.id = ticketSnap.id;
                    showModal(ticketData);
                }
            }
        });

        function showModal(ticket) {
            modalBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                    <div><strong class="text-gray-500 block">ID Ticket:</strong> #${ticket.id.substring(0, 6)}</div>
                    <div><strong class="text-gray-500 block">Fecha:</strong> ${ticket.fechaCreacion ? new Date(ticket.fechaCreacion.seconds * 1000).toLocaleString() : 'N/A'}</div>
                    <div><strong class="text-gray-500 block">Cliente:</strong> ${ticket.nombre}</div>
                    <div><strong class="text-gray-500 block">Email:</strong> <a href="mailto:${ticket.email}" class="text-lime-600">${ticket.email}</a></div>
                    <div><strong class="text-gray-500 block">Teléfono:</strong> <a href="tel:${ticket.telefono}" class="text-lime-600">${ticket.telefono}</a></div>
                    <div><strong class="text-gray-500 block">Empresa:</strong> ${ticket.empresa || 'N/A'}</div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <strong class="text-gray-500 block">Descripción del Problema:</strong>
                    <p class="mt-1 text-gray-700 whitespace-pre-wrap bg-slate-50 p-3 rounded-md">${ticket.descripcion}</p>
                </div>
                <div class="mt-4 pt-4 border-t grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                     <div>
                        <label for="status-selector" class="text-sm font-medium text-gray-700 block">Estado Actual:</label>
                        <select id="status-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm rounded-md">
                            <option value="Abierto" ${ticket.estado === 'Abierto' ? 'selected' : ''}>Abierto</option>
                            <option value="En Proceso" ${ticket.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                            <option value="Cerrado" ${ticket.estado === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                        </select>
                    </div>
                    <div>
                        <label for="asignado-a" class="text-sm font-medium text-gray-700 block">Asignado a:</label>
                        <input type="text" id="asignado-a" value="${ticket.asignadoA || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-lime-500 focus:border-lime-500">
                    </div>
                </div>
                 <div class="mt-4 pt-4 border-t">
                    <label for="notas-internas" class="text-sm font-medium text-gray-700 block">Notas Internas (visibles solo para administradores):</label>
                    <textarea id="notas-internas" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-lime-500 focus:border-lime-500">${ticket.notasInternas || ''}</textarea>
                </div>
            `;
            modal.classList.remove('hidden');
        }
        
        saveChangesButton.addEventListener('click', () => {
            if (currentEditingTicketId) {
                const updatedData = {
                    estado: document.getElementById('status-selector').value,
                    asignadoA: document.getElementById('asignado-a').value,
                    notasInternas: document.getElementById('notas-internas').value
                };
                updateTicket(currentEditingTicketId, updatedData);
                modal.classList.add('hidden');
            }
        });

        closeModalButton.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
        
        // Export to CSV Logic
        const exportButton = document.getElementById('export-csv-button');
        exportButton.addEventListener('click', async () => {
            const ticketsCollectionPath = `/artifacts/${appId}/public/data/tickets`;
            const ticketsQuery = query(collection(db, ticketsCollectionPath), orderBy("fechaCreacion", "desc"));
            const snapshot = await getDocs(ticketsQuery);
            
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["ID Ticket", "Fecha Creacion", "Cliente", "Email", "Telefono", "Empresa", "Tipo Solicitud", "Modelo Equipo", "Descripcion", "Estado", "Asignado a", "Notas Internas"];
            csvContent += headers.join(",") + "\r\n";

            snapshot.forEach(doc => {
                const t = doc.data();
                const row = [
                    `"${doc.id}"`,
                    `"${t.fechaCreacion ? new Date(t.fechaCreacion.seconds * 1000).toLocaleString('es-EC') : 'N/A'}"`,
                    `"${t.nombre || ''}"`,
                    `"${t.email || ''}"`,
                    `"${t.telefono || ''}"`,
                    `"${t.empresa || ''}"`,
                    `"${t.tipoSolicitud || ''}"`,
                    `"${t.modeloEquipo || ''}"`,
                    `"${(t.descripcion || '').replace(/"/g, '""')}"`, // Handle quotes in description
                    `"${t.estado || ''}"`,
                    `"${t.asignadoA || ''}"`,
                    `"${(t.notasInternas || '').replace(/"/g, '""')}"`
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `reporte_tickets_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>
</html>
