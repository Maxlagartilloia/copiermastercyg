<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Tickets de Soporte - Copiermaster C&G</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        /* Style for table headers */
        th {
            position: sticky;
            top: 0;
            background-color: #f8fafc; /* bg-slate-50 */
        }
    </style>
</head>
<body class="bg-slate-100">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Panel de Administración de Tickets</h1>
            <div class="flex items-center gap-2 text-gray-600">
                <i data-lucide="shield" class="h-6 w-6 text-lime-500"></i>
                <span class="font-semibold">Acceso Interno</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div id="loader" class="text-center py-12">
            <div class="w-8 h-8 border-4 border-lime-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p class="mt-4 text-gray-600">Cargando tickets...</p>
        </div>

        <div id="tickets-container" class="hidden bg-white p-6 rounded-lg shadow-lg border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Ticket</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo de Solicitud</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tickets-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Tickets will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
             <p id="no-tickets-message" class="hidden text-center py-12 text-gray-500">No hay tickets para mostrar.</p>
        </div>
    </main>

    <!-- Modal for Ticket Details -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Detalles del Ticket</h2>
                <button id="close-modal-button" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="modal-body" class="p-6 space-y-4">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID", storageBucket: "YOUR_STORAGE_BUCKET", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function authenticateAndFetchTickets() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Admin authentication successful.");
                listenForTickets(); // Start listening for tickets after auth
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                document.getElementById('loader').innerHTML = '<p class="text-red-600">Error de autenticación. No se pueden cargar los tickets.</p>';
            }
        }

        function listenForTickets() {
            const ticketsCollectionPath = `/artifacts/${appId}/public/data/tickets`;
            const ticketsQuery = query(collection(db, ticketsCollectionPath), orderBy("fechaCreacion", "desc"));

            onSnapshot(ticketsQuery, (snapshot) => {
                const ticketsTableBody = document.getElementById('tickets-table-body');
                const loader = document.getElementById('loader');
                const ticketsContainer = document.getElementById('tickets-container');
                const noTicketsMessage = document.getElementById('no-tickets-message');
                
                ticketsTableBody.innerHTML = ''; // Clear previous tickets
                loader.classList.add('hidden');
                ticketsContainer.classList.remove('hidden');

                if (snapshot.empty) {
                    noTicketsMessage.classList.remove('hidden');
                } else {
                    noTicketsMessage.classList.add('hidden');
                }

                snapshot.forEach(doc => {
                    const ticket = doc.data();
                    ticket.id = doc.id;
                    const row = createTicketRow(ticket);
                    ticketsTableBody.appendChild(row);
                });
                lucide.createIcons(); // Re-render icons after adding new elements
            }, (error) => {
                console.error("Error listening for tickets:", error);
                document.getElementById('loader').innerHTML = '<p class="text-red-600">No se pudieron cargar los tickets. Intenta recargar la página.</p>';
            });
        }

        function createTicketRow(ticket) {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            
            const statusColor = getStatusColor(ticket.estado);
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${ticket.id.substring(0, 6)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ticket.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ticket.tipoSolicitud}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ticket.fechaCreacion ? new Date(ticket.fechaCreacion.seconds * 1000).toLocaleString() : 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${ticket.estado}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button data-ticket-id="${ticket.id}" class="view-details-button text-lime-600 hover:text-lime-900">Ver Detalles</button>
                </td>
            `;
            return tr;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Abierto': return 'bg-blue-100 text-blue-800';
                case 'En Proceso': return 'bg-yellow-100 text-yellow-800';
                case 'Cerrado': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        async function updateTicketStatus(ticketId, newStatus) {
            const ticketDocRef = doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId);
            try {
                await updateDoc(ticketDocRef, { estado: newStatus });
                console.log(`Ticket ${ticketId} status updated to ${newStatus}`);
            } catch (error) {
                console.error("Error updating status: ", error);
            }
        }

        // Modal Logic
        const modal = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const closeModalButton = document.getElementById('close-modal-button');

        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('view-details-button')) {
                const ticketId = e.target.dataset.ticketId;
                const ticketDoc = await (await getFirestore(app).collection(`/artifacts/${appId}/public/data/tickets`).doc(ticketId).get()).data();
                ticketDoc.id = ticketId;
                showModal(ticketDoc);
            }
        });

        function showModal(ticket) {
            modalBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div><strong class="text-gray-500 block">ID Ticket:</strong> #${ticket.id.substring(0, 6)}</div>
                    <div><strong class="text-gray-500 block">Fecha:</strong> ${ticket.fechaCreacion ? new Date(ticket.fechaCreacion.seconds * 1000).toLocaleString() : 'N/A'}</div>
                    <div><strong class="text-gray-500 block">Cliente:</strong> ${ticket.nombre}</div>
                    <div><strong class="text-gray-500 block">Email:</strong> <a href="mailto:${ticket.email}" class="text-lime-600">${ticket.email}</a></div>
                    <div><strong class="text-gray-500 block">Teléfono:</strong> <a href="tel:${ticket.telefono}" class="text-lime-600">${ticket.telefono}</a></div>
                    <div><strong class="text-gray-500 block">Empresa:</strong> ${ticket.empresa || 'N/A'}</div>
                    <div><strong class="text-gray-500 block">Modelo Equipo:</strong> ${ticket.modeloEquipo || 'N/A'}</div>
                    <div>
                        <strong class="text-gray-500 block">Estado Actual:</strong>
                        <select id="status-selector" data-ticket-id="${ticket.id}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm rounded-md">
                            <option value="Abierto" ${ticket.estado === 'Abierto' ? 'selected' : ''}>Abierto</option>
                            <option value="En Proceso" ${ticket.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                            <option value="Cerrado" ${ticket.estado === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <strong class="text-gray-500 block">Descripción del Problema:</strong>
                    <p class="mt-1 text-gray-700 whitespace-pre-wrap">${ticket.descripcion}</p>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        closeModalButton.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
        
        // Handle status change from modal
        document.addEventListener('change', (e) => {
            if (e.target.id === 'status-selector') {
                const ticketId = e.target.dataset.ticketId;
                const newStatus = e.target.value;
                updateTicketStatus(ticketId, newStatus);
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            authenticateAndFetchTickets();
        });

    </script>
</body>
</html>
